########################################################################################################################
#                                                       VARIABLE                                                       #
########################################################################################################################
BUILD_D		:=	build

NAME		:=	$(BUILD_D)/pongCLI

CERT		:=	ft_transcendence.crt

########################################################################################################################
#                                                        FLAGS                                                         #
########################################################################################################################
ARGS		?=	#

MFLAGS		:=	--jobs=$(shell nproc)

########################################################################################################################
#                                                        DEBUG                                                         #
########################################################################################################################
DEBUG		=	no

ifeq ($(DEBUG), yes)
	CXXFLAGS	+=	-fsanitize=address
endif

IGN_LEAK	:=	valgrind_ignore_leaks.txt

VALGRIND	:=	valgrind --leak-check=full --show-leak-kinds=all\
				--track-fds=yes --show-mismatched-frees=yes --read-var-info=yes --track-origins=yes -s
#				--default-suppressions=no

########################################################################################################################
#                                                        COLORS                                                        #
########################################################################################################################
BLUE		:=	\001\033[34m\002

BOLD		:=	\001\033[1m\002

ITALIC		:=	\001\033[3m\002

RESET		:=	\001\033[0m\002

########################################################################################################################
#                                                        RULES                                                         #
########################################################################################################################
.DEFAULT_GOAL = all

.PHONY: all
all			:	$(NAME) $(CERT) banner

.PHONY: $(NAME)
$(NAME)		:	$(BUILD_D)
			$(MAKE) $(MFLAGS) -C $(BUILD_D)

$(BUILD_D)	:
			cmake -B $(BUILD_D)

.PHONY: run
run			:	$(NAME)
			./$(NAME) $(ARGS)

.PHONY: leaks
leaks		:	$(NAME)
			$(VALGRIND) ./$(NAME) $(ARGS)

$(CERT)		:
			openssl s_client -connect localhost:4443 -servername localhost </dev/null \
				| sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > $(BUILD_D)/$(CERT)

########################################################################################################################
#                                                    MISCELLANEOUS                                                     #
########################################################################################################################
.PHONY: banner
banner		:
			@echo -en '$(BLUE)'
			@echo -e '                                        ___ '
			@echo -e '    ____  ____  ____  ____ _      _____/ (_)'
			@echo -e '   / __ \/ __ \/ __ \/ __ `/_____/ ___/ / / '
			@echo -e '  / /_/ / /_/ / / / / /_/ /_____/ /__/ / /  '
			@echo -e ' / .___/\____/_/ /_/\__, /      \___/_/_/   '
			@echo -e '/_/                /____/                   '
			@echo -en '$(BOLD)''$(ITALIC)'
			@echo -e '                           üç¶   xcharra'
			@echo -e '$(RESET)'

.PHONY: clean
clean		:
			$(RM) $(BUILD_D)

.PHONY: fclean
fclean		:	clean
			$(RM) $(BUILD_D)
			$(RM) $(CERT)

.PHONY: re
re			:	fclean all
